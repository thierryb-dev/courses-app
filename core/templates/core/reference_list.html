{% extends "core/base.html" %}
{% block title %}Catalogue — {{ household.name }}{% endblock %}

{% block content %}
  <div class="row" style="justify-content:space-between;">
    <div>
      <h1>Catalogue</h1>
      <div class="muted">{{ household.name }} — Sélectionne puis génère la liste magasin.</div>
    </div>
    <div class="kpi">
      <div class="pill"><strong>{{ selected_count }}</strong> sélectionné(s)</div>
      <form method="post" action="{% url 'generate_shopping_list_from_reference' household.id %}">
        {% csrf_token %}
        <button class="btn-primary" type="submit" {% if selected_count == 0 %}disabled{% endif %}>
          Générer la liste
        </button>
      </form>
    </div>
  </div>

  <div class="card">
    <h2>Ajouter un produit</h2>
    <form method="post">
      {% csrf_token %}
      <div class="row">
        <input name="name" placeholder="Produit (ex : Pâtes)" required style="flex:1; min-width:220px;">
        <select name="aisle">
          {% for k, label in aisle_choices %}
            <option value="{{ k }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="default_quantity" placeholder="Qté (ex : 2)" style="width:160px;">
        <input name="default_note" placeholder="Note (ex : sans gluten)" style="flex:1; min-width:200px;">
        <button class="btn-primary" type="submit">Ajouter</button>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h2>Produits</h2>

      <form method="post" action="{% url 'reference_clear_selected' household.id %}">
        {% csrf_token %}
        <button type="submit">Vider sélection</button>
      </form>
    </div>

    <ul class="list">
      {% for it in items %}
        <li>
          <div class="row" style="justify-content:space-between;">
            <div>
              <div style="font-weight:800;">{{ it.name }}</div>
              <div class="muted">{{ it.get_aisle_display }}{% if it.default_quantity %} • {{ it.default_quantity }}{% endif %}{% if it.default_note %} • {{ it.default_note }}{% endif %}</div>
            </div>

            <div class="row">
              <form method="post" action="{% url 'reference_toggle_selected' it.id %}">
                {% csrf_token %}
                <button type="submit" {% if not it.is_active %}disabled{% endif %}>
                  {% if it.is_selected %}✓ Sélectionné{% else %}+ Sélectionner{% endif %}
                </button>
              </form>

              <form method="post" action="{% url 'reference_toggle_active' it.id %}">
                {% csrf_token %}
                {% if it.is_active %}
                  <button class="btn-danger" type="submit">Désactiver</button>
                {% else %}
                  <button type="submit">Activer</button>
                {% endif %}
              </form>
            </div>
          </div>
        </li>
      {% empty %}
        <li class="muted">Aucun produit dans le catalogue.</li>
      {% endfor %}
    </ul>
  </div>
{% endblock %}
