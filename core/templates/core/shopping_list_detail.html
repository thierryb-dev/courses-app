{% extends "core/base.html" %}
{% block title %}Liste ‚Äî {{ shopping_list.household.name }}{% endblock %}
{% block content %}

  <div class="card">
    <div class="page-titlebar">
      <div>
        <h1 style="margin:0;">{{ shopping_list.name }}</h1>
        <div class="muted mt-8">
          Foyer : <strong>{{ shopping_list.household.name }}</strong>
          {% if is_closed %}
            ‚Ä¢ <span class="pill">Cl√¥tur√©e</span>
          {% else %}
            ‚Ä¢ <span class="pill">Ouverte</span>
          {% endif %}
        </div>

        <div class="kpi mt-10">
          <div class="pill">Pris ‚úÖ : <strong>{{ checked_count }}</strong></div>
          <div class="pill">Prix manquants : <strong>{{ missing_estimate_count }}</strong></div>
        </div>
      </div>

      <div class="total-box">
        <div class="label">Co√ªt panier estim√© (items coch√©s)</div>
        <div class="value">{{ running_total|floatformat:2 }} ‚Ç¨</div>
        <div class="hint">(en magasin : ajuste surtout les produits au poids)</div>
      </div>
    </div>
  </div>

  <div class="card mt-12">
    <div class="section-head">
      <div>
        <div style="font-weight:800;">Phase caisse</div>
        <div class="muted">Quand tu es pr√™t, cr√©e le ticket √† partir des items coch√©s ‚úÖ.</div>
      </div>

      <div class="row" style="gap:10px;">
        {% if receipt %}
          <a class="btn-primary" href="{% url 'receipt_detail' receipt.id %}">Ouvrir le ticket</a>
        {% else %}
          <form method="post" action="{% url 'create_receipt' shopping_list.id %}" style="margin:0;">
            {% csrf_token %}
            <button class="btn-primary" type="submit" {% if not has_checked or is_closed %}disabled{% endif %}>
              Je passe en caisse ‚Üí Cr√©er le ticket
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    {% if not receipt and not has_checked %}
      <div class="muted mt-8">(Coche au moins un produit pris en rayon pour activer la caisse.)</div>
    {% endif %}
    {% if is_closed %}
      <div class="muted mt-8">Liste cl√¥tur√©e : aucune modification n'est autoris√©e.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>Ajouter un item</h2>

    {% if is_closed %}
      <div class="muted">Liste cl√¥tur√©e : ajout d'items d√©sactiv√©.</div>
    {% else %}
      <form method="post" action="{% url 'add_list_item' shopping_list.id %}">
        {% csrf_token %}
        <div class="row" style="gap:8px; align-items:center;">
          <input name="name" placeholder="Ex : Lait" required style="flex:1; min-width:220px;">
          <select name="aisle" style="min-width:200px;">
            {% for k, label in aisle_choices %}
              <option value="{{ k }}">{{ label }}</option>
            {% endfor %}
          </select>
          <input name="quantity" placeholder="Quantit√© (ex : 2, 500g‚Ä¶)" style="width:200px;">
          <input name="note" placeholder="Note (optionnel)" style="flex:1; min-width:220px;">
          <button class="btn-primary" type="submit">Ajouter</button>
        </div>
      </form>
    {% endif %}
  </div>

  <div class="card">
    <h2>Items</h2>

    {% if items %}
      <div class="items-stack">
        {% for item in items %}
          <div class="item-card {% if item.is_checked %}item-card--checked{% endif %}">
            <div class="item-card__inner">

              <div class="item-main">
                {% if is_closed %}
                  <div class="btn-secondary" style="min-width:110px; text-align:center; opacity:.7;">
                    {% if item.is_checked %}Pris ‚úÖ{% else %}√Ä prendre{% endif %}
                  </div>
                {% else %}
                  <form method="post" action="{% url 'toggle_list_item' item.id %}" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit"
                            class="{% if item.is_checked %}btn-success{% else %}btn-secondary{% endif %}"
                            style="min-width:110px;">
                      {% if item.is_checked %}Pris ‚úÖ{% else %}√Ä prendre{% endif %}
                    </button>
                  </form>
                {% endif %}

                <div>
                  <div class="item-title">{{ item.name }}</div>
                  <div class="item-meta">
                    Rayon : {{ item.get_aisle_display }}
                    {% if item.quantity %} ‚Ä¢ Quantit√© : {{ item.quantity }}{% endif %}
                  </div>
                  {% if item.note %}
                    <div class="item-note">üìù {{ item.note }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="price-box">
                <div class="price-label">Prix estim√© (focus apr√®s ‚ÄúPris ‚úÖ‚Äù)</div>

                {% if is_closed %}
                  {% if item.estimated_price is not None %}
                    <span class="price-value">{{ item.estimated_price|floatformat:2 }} ‚Ç¨</span>
                  {% else %}
                    <span class="price-empty">‚Äî</span>
                  {% endif %}
                {% else %}
                  <form method="post" action="{% url 'update_estimated_price' item.id %}" class="price-form">
                    {% csrf_token %}
                    <input
                      class="price-input"
                      id="price-{{ item.id }}"
                      data-price-input="1"
                      data-item-id="{{ item.id }}"
                      data-is-checked="{% if item.is_checked %}1{% else %}0{% endif %}"
                      data-has-price="{% if item.estimated_price is not None %}1{% else %}0{% endif %}"
                      name="estimated_price"
                      inputmode="decimal"
                      placeholder="ex : 3.49"
                      value="{% if item.estimated_price is not None %}{{ item.estimated_price|floatformat:2 }}{% endif %}"
                    >
                    <button type="submit" class="btn-primary">OK</button>

                    {% if item.estimated_price is not None %}
                      <span class="price-value">{{ item.estimated_price|floatformat:2 }} ‚Ç¨</span>
                    {% else %}
                      <span class="price-empty">‚Äî</span>
                    {% endif %}
                  </form>

                  <form method="post" action="{% url 'delete_list_item' item.id %}" style="margin-top:8px;">
                    {% csrf_token %}
                    <button type="submit" class="btn-secondary">Supprimer</button>
                  </form>
                {% endif %}
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Aucun item pour le moment.</p>
    {% endif %}
  </div>

  <div class="mt-10">
    <a class="btn-secondary" href="{% url 'shopping_lists' %}">‚Üê Retour aux listes</a>
  </div>

  {% if not is_closed %}
  <script>
    (function () {
      try {
        const focusId = {% if focus_price_id %}{{ focus_price_id }}{% else %}null{% endif %};

        function focusInput(el){
          el.classList.add("is-focus-target");
          el.focus({ preventScroll: true });
          el.scrollIntoView({ block: "center", behavior: "smooth" });
          if (el.select) el.select();
        }

        if (focusId) {
          const el = document.getElementById("price-" + focusId);
          if (el) return focusInput(el);
        }

        // fallback : 1er coch√© sans prix
        const inputs = Array.from(document.querySelectorAll('input[data-price-input="1"]'));
        const target = inputs.find(i => i.dataset.isChecked === "1" && i.dataset.hasPrice === "0");
        if (target) focusInput(target);
      } catch (e) {}
    })();
  </script>
  {% endif %}

{% endblock %}
