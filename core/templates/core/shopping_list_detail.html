{% extends "core/base.html" %}

{% block title %}Liste ‚Äî {{ shopping_list.household.name }}{% endblock %}

{% block content %}
<div class="container">

  <!-- Header -->
  <div class="card">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap;">
      <div>
        <h1 style="margin:0;">{{ shopping_list.name }}</h1>
        <div style="opacity:.8; margin-top:6px;">
          Foyer : <strong>{{ shopping_list.household.name }}</strong>
          {% if is_closed %}
            ‚Ä¢ <span class="pill">Cl√¥tur√©e</span>
          {% else %}
            ‚Ä¢ <span class="pill">Ouverte</span>
          {% endif %}
        </div>
      </div>

      <div style="text-align:right; min-width:260px;">
        <div style="font-size:14px; opacity:.8;">Co√ªt panier estim√© (items coch√©s)</div>
        <div style="font-size:28px; font-weight:700;">
          {{ running_total|floatformat:2 }} ‚Ç¨
        </div>
        <div style="font-size:12px; opacity:.7; margin-top:4px;">
          (utile avant passage en caisse)
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket (apr√®s caisse) -->
  <div class="card" style="margin-top:12px;">
    <div class="row" style="justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
      <div>
        <div style="font-weight:800;">Ticket (apr√®s caisse)</div>
        <div class="muted">
          Cr√©e un ticket √† partir des items coch√©s ‚úÖ puis saisis les prix r√©els et le total.
        </div>
      </div>

      <div class="row" style="gap:10px; flex-wrap:wrap;">
        {% if receipt %}
          <a class="btn-primary" href="{% url 'receipt_detail' receipt.id %}">Ouvrir le ticket</a>
        {% else %}
          <form method="post" action="{% url 'create_receipt' shopping_list.id %}" style="margin:0;">
            {% csrf_token %}
            <button class="btn-primary" type="submit" {% if not has_checked or is_closed %}disabled{% endif %}>
              Cr√©er le ticket
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    {% if not receipt and not has_checked %}
      <div class="muted" style="margin-top:8px;">
        (Coche au moins un produit pris en rayon pour activer la cr√©ation du ticket.)
      </div>
    {% endif %}

    {% if is_closed %}
      <div class="muted" style="margin-top:8px;">
        Cette liste est cl√¥tur√©e : aucune modification n'est autoris√©e.
      </div>
    {% endif %}
  </div>

  <!-- Add item -->
  <div class="card">
    <h2>Ajouter un item</h2>

    {% if is_closed %}
      <div class="muted">Liste cl√¥tur√©e : ajout d'items d√©sactiv√©.</div>
    {% else %}
      <form method="post" action="{% url 'add_list_item' shopping_list.id %}">
        {% csrf_token %}
        <div class="row" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input name="name" placeholder="Ex : Lait" required style="flex:1; min-width:220px;">
          <select name="aisle" style="min-width:200px;">
            {% for k, label in aisle_choices %}
              <option value="{{ k }}">{{ label }}</option>
            {% endfor %}
          </select>
          <input name="quantity" placeholder="Quantit√© (ex : 2, 500g‚Ä¶)" style="width:200px;">
          <input name="note" placeholder="Note (optionnel)" style="flex:1; min-width:220px;">
          <button class="btn-primary" type="submit">Ajouter</button>
        </div>
      </form>
    {% endif %}
  </div>

  <!-- Items -->
  <div class="card">
    <h2>Items</h2>

    {% if items %}
      <div style="display:flex; flex-direction:column; gap:10px;">

        {% for item in items %}
          <div style="border:1px solid rgba(0,0,0,.08); border-radius:10px; padding:12px;">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">

              <div style="display:flex; gap:10px; align-items:flex-start; min-width:280px; flex:1;">

                {% if is_closed %}
                  <div class="btn-secondary" style="min-width:110px; text-align:center; opacity:.7;">
                    {% if item.is_checked %}Pris ‚úÖ{% else %}√Ä prendre{% endif %}
                  </div>
                {% else %}
                  <form method="post" action="{% url 'toggle_list_item' item.id %}" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit"
                            class="{% if item.is_checked %}btn-success{% else %}btn-secondary{% endif %}"
                            style="min-width:110px;">
                      {% if item.is_checked %}Pris ‚úÖ{% else %}√Ä prendre{% endif %}
                    </button>
                  </form>
                {% endif %}

                <div>
                  <div style="font-weight:700; font-size:16px;">
                    {{ item.name }}
                  </div>

                  <div style="opacity:.8; margin-top:2px; font-size:13px;">
                    Rayon : {{ item.get_aisle_display }}
                    {% if item.quantity %} ‚Ä¢ Quantit√© : {{ item.quantity }}{% endif %}
                  </div>

                  {% if item.note %}
                    <div style="margin-top:6px; font-size:13px; opacity:.85;">
                      üìù {{ item.note }}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div style="min-width:340px; flex:0;">
                <div style="font-size:13px; opacity:.8; margin-bottom:6px;">
                  Prix estim√© (modifiable, notamment pour le poids)
                </div>

                {% if is_closed %}
                  <div class="row" style="gap:8px; align-items:center;">
                    {% if item.estimated_price is not None %}
                      <span style="opacity:.9;">{{ item.estimated_price|floatformat:2 }} ‚Ç¨</span>
                    {% else %}
                      <span style="opacity:.6;">‚Äî</span>
                    {% endif %}
                  </div>
                {% else %}
                  <form method="post" action="{% url 'update_estimated_price' item.id %}"
                        style="display:flex; gap:8px; align-items:center; margin:0;">
                    {% csrf_token %}
                    <input
                      name="estimated_price"
                      inputmode="decimal"
                      placeholder="ex : 3.49"
                      value="{% if item.estimated_price is not None %}{{ item.estimated_price|floatformat:2 }}{% endif %}"
                      style="width:140px;"
                    >
                    <button type="submit" class="btn-primary">OK</button>

                    {% if item.estimated_price is not None %}
                      <span style="opacity:.9;">{{ item.estimated_price|floatformat:2 }} ‚Ç¨</span>
                    {% else %}
                      <span style="opacity:.6;">‚Äî</span>
                    {% endif %}
                  </form>

                  <form method="post" action="{% url 'delete_list_item' item.id %}" style="margin-top:8px;">
                    {% csrf_token %}
                    <button type="submit" class="btn-secondary">Supprimer</button>
                  </form>

                  <div style="margin-top:6px; font-size:12px; opacity:.7;">
                    Astuce : mets une estimation, puis ajuste quand le poids/prix exact est connu.
                  </div>
                {% endif %}
              </div>

            </div>
          </div>
        {% endfor %}

      </div>
    {% else %}
      <p style="opacity:.8;">Aucun item pour le moment.</p>
    {% endif %}
  </div>

  <div style="margin-top:10px;">
    <a class="btn-secondary" href="{% url 'shopping_lists' %}">‚Üê Retour aux listes</a>
  </div>

</div>
{% endblock %}
